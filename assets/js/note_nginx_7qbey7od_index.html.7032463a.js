"use strict";(self.webpackChunkunravely_blog=self.webpackChunkunravely_blog||[]).push([[1695],{9083:(s,i,a)=>{a.r(i),a.d(i,{comp:()=>p,data:()=>h});var n=a(6254),l=a(8627);const e={},p=(0,a(1021).A)(e,[["render",function(s,i){return(0,n.uX)(),(0,n.CE)("div",null,[i[1]||(i[1]=(0,n.Fv)('<p>参考：<a href="https://www.cnblogs.com/54chensongxia/p/12938929.html" target="_blank" rel="noopener noreferrer">Nginx配置文件详解 - 博客园</a></p><p><a href="https://cloud.tencent.com/document/product/400/35244" target="_blank" rel="noopener noreferrer">安装ssl证书</a></p><p>nginx控制文件上传大小：<code>在http{} 中加入 client_max_body_size 100m;</code></p><h2 id="_0-直接用版本" tabindex="-1"><a class="header-anchor" href="#_0-直接用版本"><span>0. 直接用版本</span></a></h2><h3 id="后端调用" tabindex="-1"><a class="header-anchor" href="#后端调用"><span>后端调用</span></a></h3><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">upstream</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cloudServer</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 127.0.0.1:9100</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #server 127.0.0.1:9003 backup;  #热备</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  {</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        listen</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">       80</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        server_name</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  localhost</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        location</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">                root</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   /usr/share/nginx/html</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                #root /var/www/html;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">                try_files</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $uri</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $uri</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /index.html</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">                index</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> index.html</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> index.htm</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        }</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        location</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /nacos</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">                proxy_pass</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  http://127.0.0.1:10100</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        }</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">\t\t\t\t# 限制外网访问内网 actuator 相关路径</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        location</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ~</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ^</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">/[^/]*</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">?/actuator</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">/.*</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">?</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">$ </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{</span></span>\n<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">            return</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 403</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        }</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        </span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        location</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /prod-api/</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                # 设置请求头中的Host字段</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">                proxy_set_header</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Host</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $host</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                # 设置HTTP头中的X-Forwarded-For字段，表示客户端真实IP，多个IP用逗号隔开</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">                proxy_set_header</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> X-Forwarded-For</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $proxy_add_x_forwarded_for</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                # 设置请求头中的X-Real-IP字段，表示客户端真实IP</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">                proxy_set_header</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> X-Real-IP</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $remote_addr</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">                proxy_set_header</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> REMOTE_HOST</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $remote_addr</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">                proxy_pass</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  http://cloudServer/</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        }</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        error_page</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">   500</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 502</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 503</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 504</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  /50x.html</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        location</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> =</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /50x.html</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">            root</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   html</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        }</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        </span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="证书配置" tabindex="-1"><a class="header-anchor" href="#证书配置"><span>证书配置</span></a></h3><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    #SSL 默认访问端口号为 443</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    listen</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 443</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ssl</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    #请填写绑定证书的域名</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    server_name</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> unravely.cn</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    #请填写证书文件的相对路径或绝对路径</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    ssl_certificate</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/nginx/unravely.cn_bundle.crt</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    #请填写私钥文件的相对路径或绝对路径</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    ssl_certificate_key</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/nginx/unravely.cn.key</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    ssl_session_timeout</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 5m</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    #请按照以下协议配置</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    ssl_protocols</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> TLSv1.2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> TLSv1.3</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    #请按照以下套件配置，配置加密套件，写法遵循 openssl 标准。</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    ssl_ciphers</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    ssl_prefer_server_ciphers</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> on</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    #access_log  /var/log/nginx/host.access.log  main;</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    # 处理 immich 请求</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    location</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /immich</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        proxy_pass</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> http://127.0.0.1:2283</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        proxy_set_header</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Host</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $host</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        proxy_set_header</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> X-Real-IP</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $remote_addr</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        proxy_set_header</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> X-Forwarded-For</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $proxy_add_x_forwarded_for</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        proxy_set_header</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> X-Forwarded-Proto</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $scheme</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    }</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    location</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #root   /usr/share/nginx/html;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        root</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    /data/vuepress/dist</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        index</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  index.html</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> index.htm</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">   </span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        # 缓存时间7天</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        expires</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 7d</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    }</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    #error_page  404              /404.html;</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    # redirect server error pages to the static page /50x.html</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    error_page</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">   500</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 502</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 503</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 504</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  /50x.html</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    location</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> =</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /50x.html</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        root</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   /usr/share/nginx/html</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    }</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    listen</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">       80</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    server_name</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  unravely.cn</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">  </span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    # 处理 immich 请求</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    location</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /immich</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        proxy_pass</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> http://127.0.0.1:2283</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        proxy_set_header</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Host</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $host</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        proxy_set_header</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> X-Real-IP</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $remote_addr</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        proxy_set_header</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> X-Forwarded-For</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $proxy_add_x_forwarded_for</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        proxy_set_header</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> X-Forwarded-Proto</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $scheme</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    }</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    # 其他请求重定向到 HTTPS</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    location</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>\n<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        return</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 301</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> https://</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">$host$request_uri</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    }</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="开启压缩" tabindex="-1"><a class="header-anchor" href="#开启压缩"><span>开启压缩</span></a></h3><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">user</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  nginx</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">worker_processes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  auto</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">error_log</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  /var/log/nginx/error.log</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> notice</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">pid</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        /var/run/nginx.pid</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">events</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    worker_connections</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">  1024</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    # 允许一个进程同时接受多个连接</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    multi_accept</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> on</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    # 使用高效的事件模型</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    use</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> epoll</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">  </span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">http</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    include</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">       /etc/nginx/mime.types</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    default_type</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  application/octet-stream</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    # 限制body大小 默认：1M</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    client_max_body_size</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 100m</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    log_format</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  main</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">  &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">$remote_addr - $remote_user [$time_local] &quot;$request&quot; </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    access_log</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  /var/log/nginx/access.log</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  main</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    sendfile</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     on</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    tcp_nopush</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   on</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    keepalive_timeout</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">  65</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    gzip</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  on</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    # 启用gzip压缩的最小文件，小于设置值的文件将不会压缩</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    gzip_min_length</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 1k</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    # gzip 压缩级别，1-10，数字越大压缩的越好，也越占用CPU时间。一般设置1和2</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    gzip_comp_level</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 5</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    # 进行压缩的文件类型。javascript有多种形式。其中的值可以在 mime.types 文件中找到。</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    gzip_types</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> text/plain</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> application/javascript</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> application/x-javascript</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> text/css</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> application/xml</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> text/javascript</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> application/x-httpd-php</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> image/jpeg</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> image/gif</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> image/png</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    # 是否在http header中添加Vary: Accept-Encoding，建议开启</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    gzip_vary</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> on</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    # 禁用IE 6 gzip</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    gzip_disable</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">MSIE [1-6]\\.</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    include</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/nginx/conf.d/</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">*</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">.conf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_1-配置文件结构" tabindex="-1"><a class="header-anchor" href="#_1-配置文件结构"><span>1. 配置文件结构</span></a></h2><ul><li>1、<strong>全局块</strong>：配置影响nginx全局的指令。一般有运行nginx服务器的用户组，nginx进程pid存放路径，日志存放路径，配置文件引入，允许生成worker process数等。</li><li>2、<strong>events块</strong>：配置影响nginx服务器或与用户的网络连接。有每个进程的最大连接数，选取哪种事件驱动模型处理连接请求，是否允许同时接受多个网路连接，开启多个网络连接序列化等。</li><li>3、<strong>http块</strong>：可以嵌套多个server，配置代理，缓存，日志定义等绝大多数功能和第三方模块的配置。如文件引入，mime-type定义，日志自定义，是否使用sendfile传输文件，连接超时时间，单连接请求数等。</li><li>4、<strong>server块</strong>：配置虚拟主机的相关参数，一个http中可以有多个server。</li><li>5、<strong>location块</strong>：配置请求的路由，以及各种页面的处理情况。</li></ul><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">...</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">              #全局块</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">events</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">         #events块</span></span>\n<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">   ...</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">http</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">         #http块</span></span>\n<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    ...</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   #http全局块</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">   \tupstream</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> myserver</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   #负载均衡</span></span>\n<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        ...</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">   </span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    }</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #server块</span></span>\n<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        ...</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">       #server全局块</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        location</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> [PATTERN] </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   #location块</span></span>\n<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">            ...</span></span>\n<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        }</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        location</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> [PATTERN] </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>\n<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">                ...</span></span>\n<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        }</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    }</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    </span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>\n<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      ...</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    }</span></span>\n<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    ...</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     #http全局块</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-详细配置" tabindex="-1"><a class="header-anchor" href="#_2-详细配置"><span>2. 详细配置</span></a></h2><p><strong>每个指令必须有分号结束</strong></p><div class="language-shell line-numbers-mode has-collapsed collapsed" data-ext="shell" data-title="shell" style="--vp-collapsed-lines:20;"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">##################### 全局块 ######################</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#配置影响nginx全局的指令。一般有运行nginx服务器的用户组，nginx进程pid存放路径，日志存放路径，配置文件引入，允许生成worker process数等。</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">user</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  nginx</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> #配置用户或者组</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">worker_processes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  auto</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> #允许生成的进程数，工作进程数量，可配置成服务器内核数 * 2</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#制定日志路径，级别。这个设置可以放入全局块，http块，server块，级别为：debug|info|notice|warn|error|crit|alert|emerg</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">error_log</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  /var/log/nginx/error.log</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> notice</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">pid</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        /var/run/nginx.pid</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> #指定nginx进程运行文件存放地址</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">##################### events块 ######################</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#配置影响nginx服务器或与用户的网络连接。有每个进程的最大连接数，选取哪种事件驱动模型处理连接请求，是否允许同时接受多个网路连接，开启多个网络连接序列化等。</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">events</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    worker_connections</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">  1024</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> #最大连接数</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">##################### http块 ######################</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">http</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    include</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">       /etc/nginx/mime.types</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> #文件扩展名与文件类型映射表</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    default_type</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  application/octet-stream</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> #默认文件类型，默认为text/plain</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">\t#access_log off; #取消服务日志 </span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     #日志格式设定</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #$remote_addr与$http_x_forwarded_for用以记录客户端的ip地址；</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #$remote_user：用来记录客户端用户名称；</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #$time_local： 用来记录访问时间与时区；</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #$request： 用来记录请求的url与http协议；</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #$status： 用来记录请求状态；成功是200，</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #$body_bytes_sent ：记录发送给客户端文件主体内容大小；</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #$http_referer：用来记录从那个页面链接访问过来的；</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #$http_user_agent：记录客户浏览器的相关信息；</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #通常web服务器放在反向代理的后面，这样就不能获取到客户的IP地址了，通过$remote_add拿到的IP地址是反向代理服务器的iP地址。反向代理服务器在转发请求的http头信息中，可以增加x_forwarded_for信息，用以记录原有客户端的IP地址和原来客户端的请求的服务器地址。</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    log_format</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  main</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">  &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">$remote_addr - $remote_user [$time_local] &quot;$request&quot; </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    access_log</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  /var/log/nginx/access.log</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  main</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> #访问日志位置</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    sendfile</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        on</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> #允许sendfile方式传输文件，默认为off，可以在http块，server块，location块</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    #tcp_nopush     on; #此选项允许或禁止使用socke的TCP_CORK的选项（发送数据包前先缓存数据），此选项仅在使用sendfile的时候使用</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    </span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    keepalive_timeout</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">  65</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> #连接保持超时时间，单位是秒</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    #gzip  on; #gzip模块设置，设置是否开启gzip压缩输出</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    </span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    ##################### 负载均衡 ######################</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    upstream</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> myserver</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">   </span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">\t\tserver</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 192.168.1.11:8880</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   weight=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">5</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  \t\tserver</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 192.168.1.12:9990</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   weight=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">     \tserver</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 192.168.10.121:3333</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> backup</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  #热备</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    }</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    </span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">\t##################### 虚拟主机，可以配置多个 ######################</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        listen</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">       80</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  # ipv4 监听端口</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        listen</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">  [::]:80</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  # ipv6 监听端口</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        server_name</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  localhost</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  www.xxxxx.com</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> #站点域名，可以有多个，用空格隔开</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #access_log  /var/log/nginx/host.access.log  main;</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">\t\t</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #静态资源配置</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        location</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> #请求的url过滤，正则匹配，~为区分大小写，~*为不区分大小写</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">            root</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   /usr/share/nginx/html</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> #根目录</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">            index</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  index.html</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> index.htm</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> #设置默认页</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">            deny</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 192.168.2.11</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   #禁止访问的ip地址，可以为all</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">            allow</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 192.168.3.44；</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> #允许访问的ip地址，可以为all</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        }</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        </span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #反向代理配置</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        location</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /picx/</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">            proxy_pass</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  http://myserver</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  #请求转向mysvr 定义的服务器列表</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            #proxy_connect_timeout 90;  #nginx跟后端服务器连接超时时间(代理连接超时)</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            #proxy_send_timeout 90;     #后端服务器数据回传时间(代理发送超时)</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            #proxy_read_timeout 90;     #连接成功后,后端服务器响应时间(代理接收超时)</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            #proxy_buffer_size 4k;      #代理服务器（nginx）保存用户头信息的缓冲区大小</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            #proxy_buffers 4 32k;      #proxy_buffers缓冲区</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            #proxy_busy_buffers_size 64k;     #高负荷下缓冲大小（proxy_buffers*2）</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            #proxy_temp_file_write_size 64k;  #设定缓存文件夹大小</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">           \t#proxy_set_header Host $host; </span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            #proxy_set_header X-Forwarder-For $remote_addr;  #获取客户端真实IP</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        }</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">\t\t</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        # 重定向配置</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        location</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>\n<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">             return</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 404</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> #直接返回状态码</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        }</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        location</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>\n<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">             return</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 404</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">pages not found</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> #返回状态码 + 一段文本</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        }</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        location</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>\n<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">             return</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 302</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /blog</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> ;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> #返回状态码 + 重定向地址</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        }</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        location</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>\n<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">             return</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> https://www.mingongge.com</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> ;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> #返回重定向地址</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        }</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        </span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #error_page  404              /404.html;</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        # redirect server error pages to the static page /50x.html</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        error_page</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">   500</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 502</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 503</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 504</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  /50x.html</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        location</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> =</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /50x.html</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">            root</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   /usr/share/nginx/html</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        }</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        # proxy the PHP scripts to Apache listening on 127.0.0.1:80</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #location ~ \\.php$ {</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #    proxy_pass   http://127.0.0.1;</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #}</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #location ~ \\.php$ {</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #    root           html;</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #    fastcgi_pass   127.0.0.1:9000;</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #    fastcgi_index  index.php;</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #    include        fastcgi_params;</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #}</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        # deny access to .htaccess files, if Apache&#39;s document root</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        # concurs with nginx&#39;s one</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #location ~ /\\.ht {</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #    deny  all;</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #}</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">\t}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><h2 id="_3-域名匹配的四种写法" tabindex="-1"><a class="header-anchor" href="#_3-域名匹配的四种写法"><span>3. 域名匹配的四种写法</span></a></h2><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>精确匹配：server_name www.xxxx.com ;</span></span>\n<span class="line"><span>左侧通配：server_name *.xxxx.com ;</span></span>\n<span class="line"><span>右侧统配：server_name www.xxxx.* ;</span></span>\n<span class="line"><span>正则匹配：server_name ~^www\\.xxxx\\.*$ ;</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span>匹配优先级：精确匹配 &gt; 左侧通配符匹配 &gt; 右侧通配符匹配 &gt; 正则表达式匹配</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-location-匹配说明" tabindex="-1"><a class="header-anchor" href="#_4-location-匹配说明"><span>4. location 匹配说明</span></a></h2><ul><li><code>=</code>：用于不含正则表达式的 uri 前，要求请求字符串与 uri 严格匹配，如果匹配成功，就停止继续向下搜索并立即处理该请求。</li><li><code>~</code>：用于表示 uri 包含正则表达式，并且区分大小写。</li><li><code>~*</code>：用于表示 uri 包含正则表达式，并且不区分大小写。</li><li><code>^~</code>：用于不含正则表达式的 uri 前，要求 Nginx 服务器找到标识 uri 和请求字符串匹配度最高的 location 后，立即使用此 location 处理请求，而不再使用 location块中的正则 uri 和请求字符串做匹配。</li></ul><p>注意：如果 uri 包含正则表达式，则必须要有 ~ 或者 ~* 标识。</p><h2 id="_5-proxy-pass-匹配说明" tabindex="-1"><a class="header-anchor" href="#_5-proxy-pass-匹配说明"><span>5. proxy_pass 匹配说明</span></a></h2>',22)),(0,n.Lk)("p",null,[i[0]||(i[0]=(0,n.Lk)("strong",null,"访问路径",-1)),(0,n.eW)("："+(0,l.v_)(s.url)+":80/test/insert/a/10",1)]),i[2]||(i[2]=(0,n.Fv)('<p><strong>nginx代理</strong>：</p><div class="language-shell line-numbers-mode has-collapsed collapsed" data-ext="shell" data-title="shell" style="--vp-collapsed-lines:20;"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">upstream</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> myserver</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">   </span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 127.0.0.1:9001</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 127.0.0.1:9002</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  #server 127.0.0.1:9003 backup;  #热备</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  listen</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">       80</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  server_name</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  localhost</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  location</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /test</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    proxy_pass</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  http://myserver</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  \t#请求转向mysvr 定义的服务器列表</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    proxy_connect_timeout</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 30</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  \t\t#nginx跟后端服务器连接超时时间(代理连接超时)</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    proxy_send_timeout</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 30</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     \t\t#后端服务器数据回传时间(代理发送超时)</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    proxy_read_timeout</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 30</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     \t\t#连接成功后,后端服务器响应时间(代理接收超时)</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    proxy_set_header</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Host</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $host</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    proxy_set_header</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> X-Forwarder-For</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $remote_addr</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  #获取客户端真实IP</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">  }</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  error_page</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">   500</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 502</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 503</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 504</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  /50x.html</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  location</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> =</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /50x.html</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    root</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   /usr/share/nginx/html</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">  }</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  listen</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">       80</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  server_name</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  localhost</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  location</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /nacos</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    proxy_pass</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  http://127.0.0.1:10100</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">\t</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    # 设置请求头中的Host字段</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  \tproxy_set_header</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Host</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $host</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  \t# 设置HTTP头中的X-Forwarded-For字段，表示客户端真实IP，多个IP用逗号隔开</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  \tproxy_set_header</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> X-Forwarded-For</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $proxy_add_x_forwarded_for</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  \t# 设置请求头中的X-Real-IP字段，表示客户端真实IP</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  \tproxy_set_header</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> X-Real-IP</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $remote_addr</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    proxy_set_header</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> REMOTE_HOST</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $remote_addr</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">  }</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  location</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /kibana</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    proxy_pass</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  http://127.0.0.1:10500/</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  \t# 设置请求头中的Host字段</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  \tproxy_set_header</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Host</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $host</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  \t# 设置HTTP头中的X-Forwarded-For字段，表示客户端真实IP，多个IP用逗号隔开</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  \tproxy_set_header</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> X-Forwarded-For</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $proxy_add_x_forwarded_for</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  \t# 设置请求头中的X-Real-IP字段，表示客户端真实IP</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  \tproxy_set_header</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> X-Real-IP</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $remote_addr</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    proxy_set_header</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> REMOTE_HOST</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $remote_addr</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    </span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">  }</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p>在nginx中配置proxy_pass代理转发时：</p><ul><li>如果在proxy_pass后面的url中含有/，表示绝对根路径，匹配的location 路径就不在url里了；</li><li>如果在proxy_pass后面的url中没有/，表示相对路径，把匹配的路径部分也给代理走，要在url里留着。 proxy_pass有/，实际访问地址就没有location</li></ul><p>以下是几种常见的匹配情况，访问地址：http://localhost/proxy/abc.html</p><p>图示：</p><table><thead><tr><th>序号</th><th>location</th><th>proxy_pass</th><th>代理到</th></tr></thead><tbody><tr><td>1</td><td>/proxy/</td><td>http://127.0.0.1:8080/</td><td>http://127.0.0.1:8080/abc.html</td></tr><tr><td>2</td><td>/proxy/</td><td>http://127.0.0.1:8080</td><td>http://127.0.0.1:8080/proxy/abc.html</td></tr><tr><td>3</td><td>/proxy/</td><td>http://127.0.0.1:8080/api/</td><td>http://127.0.0.1:8080/api/abc.html</td></tr><tr><td>4</td><td>/proxy/</td><td>http://127.0.0.1:8080/api</td><td>http://127.0.0.1:8080/apiabc.html</td></tr><tr><td>5</td><td>/proxy</td><td>http://127.0.0.1:8080/</td><td>http://127.0.0.1:8080//abc.html</td></tr><tr><td>6</td><td>/proxy</td><td>http://127.0.0.1:8080</td><td>http://127.0.0.1:8080/proxy/abc.html</td></tr><tr><td>7</td><td>/proxy</td><td>http://127.0.0.1:8080/api/</td><td>http://127.0.0.1:8080/proxy//abc.html</td></tr><tr><td>8</td><td>/proxy</td><td>http://127.0.0.1:8080/api</td><td>http://127.0.0.1:8080/proxy/apiabc.html</td></tr></tbody></table><h2 id="_6-nginx负载均衡策略" tabindex="-1"><a class="header-anchor" href="#_6-nginx负载均衡策略"><span>6. nginx负载均衡策略</span></a></h2><p><strong>1.轮询（默认）</strong></p><p>每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器 down 掉，能自动剔除。</p><p><strong>2.weight</strong></p><p>weight 代表权,重默认为 1,权重越高被分配的客户端越多</p><p>指定轮询几率，weight 和访问比率成正比，用于后端服务器性能不均的情况。 例如：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">upstream</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> server_pool{</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    server</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 192.168.5.21</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> weight=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">10</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    server</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 192.168.5.22</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> weight=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">10</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>3.ip_hash</strong></p><p>每个请求按访问 ip 的 hash 结果分配，这样每个访客固定访问一个后端服务器，可以解决 session 的问题。 例如</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">upstream</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> server_pool{</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    ip_hash</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 192.168.5.21:80</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 192.168.5.22:80</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>4.fair（第三方）</strong></p><p>按后端服务器的响应时间来分配请求，响应时间短的优先分配。</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">upstream</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> server_pool{</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 192.168.5.21:80</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 192.168.5.22:80</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    fair</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-安装-ssl-配置-https" tabindex="-1"><a class="header-anchor" href="#_7-安装-ssl-配置-https"><span>7. 安装 SSL 配置 HTTPS</span></a></h2><h3 id="_7-1-下载证书并上传" tabindex="-1"><a class="header-anchor" href="#_7-1-下载证书并上传"><span>7.1 下载证书并上传</span></a></h3><p>下载申请好的 ssl 证书文件压缩包到本地并解压（这里是用的 pem 与 key 文件，文件名可以更改）。</p><p>在 nginx 目录新建 cert 文件夹存放证书文件。</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"></span>\n<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/local/nginx</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mkdir</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cert</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>将这两个文件上传至服务器的 cert 目录里。</p><h3 id="_7-2-配置ssl证书" tabindex="-1"><a class="header-anchor" href="#_7-2-配置ssl证书"><span>7.2 配置ssl证书</span></a></h3><p>配置 https <a href="https://www.aliyun.com/minisite/goods?userCode=veyumm2k" target="_blank" rel="noopener noreferrer">server</a>。注释掉之前的 http server 配置，新增 https server：</p><div class="language-shell line-numbers-mode has-collapsed collapsed" data-ext="shell" data-title="shell" style="--vp-collapsed-lines:20;"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">\t#SSL 访问端口号为 443</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    listen</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 443</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ssl</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    #填写绑定证书的域名</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    server_name</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> www.xxxx.com</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    </span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    # ssl证书地址</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    ssl_certificate</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     /usr/local/nginx/cert/ssl.pem</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  # pem文件的路径</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    ssl_certificate_key</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  /usr/local/nginx/cert/ssl.key</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # key文件的路径</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    </span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    # ssl验证相关配置</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    ssl_session_timeout</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 5m</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> #缓存有效期</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    ssl_protocols</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> TLSv1.2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> TLSv1.3</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  #安全链接可选的加密协议</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    #请按照以下套件配置，配置加密套件，写法遵循 openssl 标准。</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    ssl_ciphers</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  #加密算法 腾讯</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    ssl_prefer_server_ciphers</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> on</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> #使用服务器端的首选算法</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    location</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #网站主页路径。此路径仅供参考，具体请您按照实际目录操作。</span></span>\n<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #例如，您的网站运行目录在/etc/www下，则填写/etc/www。</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        root</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> html</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        index</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  index.html</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> index.htm</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    }</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p>将 http 重定向 https。</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    listen</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">       80</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    server_name</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  www.xxxx.com</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    return</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 301</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> https://</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">$server_name$request_uri</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>',31))])}]]),h=JSON.parse('{"path":"/note_nginx/7qbey7od/","title":"配置nginx","lang":"zh-CN","frontmatter":{"title":"配置nginx","createTime":"2024/11/14 17:42:31","permalink":"/note_nginx/7qbey7od/","description":"参考：Nginx配置文件详解 - 博客园 安装ssl证书 nginx控制文件上传大小：在http{} 中加入 client_max_body_size 100m; 0. 直接用版本 后端调用 证书配置 开启压缩 1. 配置文件结构 1、全局块：配置影响nginx全局的指令。一般有运行nginx服务器的用户组，nginx进程pid存放路径，日志存放路径，...","head":[["meta",{"property":"og:url","content":"https://www.unravely.press/note_nginx/7qbey7od/"}],["meta",{"property":"og:site_name","content":"Unravely"}],["meta",{"property":"og:title","content":"配置nginx"}],["meta",{"property":"og:description","content":"参考：Nginx配置文件详解 - 博客园 安装ssl证书 nginx控制文件上传大小：在http{} 中加入 client_max_body_size 100m; 0. 直接用版本 后端调用 证书配置 开启压缩 1. 配置文件结构 1、全局块：配置影响nginx全局的指令。一般有运行nginx服务器的用户组，nginx进程pid存放路径，日志存放路径，..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-12-06T09:17:51.000Z"}],["meta",{"property":"article:modified_time","content":"2024-12-06T09:17:51.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"配置nginx\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2024-12-06T09:17:51.000Z\\",\\"author\\":[]}"]]},"headers":[{"level":2,"title":"0. 直接用版本","slug":"_0-直接用版本","link":"#_0-直接用版本","children":[{"level":3,"title":"后端调用","slug":"后端调用","link":"#后端调用","children":[]},{"level":3,"title":"证书配置","slug":"证书配置","link":"#证书配置","children":[]},{"level":3,"title":"开启压缩","slug":"开启压缩","link":"#开启压缩","children":[]}]},{"level":2,"title":"1. 配置文件结构","slug":"_1-配置文件结构","link":"#_1-配置文件结构","children":[]},{"level":2,"title":"2. 详细配置","slug":"_2-详细配置","link":"#_2-详细配置","children":[]},{"level":2,"title":"3. 域名匹配的四种写法","slug":"_3-域名匹配的四种写法","link":"#_3-域名匹配的四种写法","children":[]},{"level":2,"title":"4. location 匹配说明","slug":"_4-location-匹配说明","link":"#_4-location-匹配说明","children":[]},{"level":2,"title":"5. proxy_pass 匹配说明","slug":"_5-proxy-pass-匹配说明","link":"#_5-proxy-pass-匹配说明","children":[]},{"level":2,"title":"6. nginx负载均衡策略","slug":"_6-nginx负载均衡策略","link":"#_6-nginx负载均衡策略","children":[]},{"level":2,"title":"7. 安装 SSL 配置 HTTPS","slug":"_7-安装-ssl-配置-https","link":"#_7-安装-ssl-配置-https","children":[{"level":3,"title":"7.1 下载证书并上传","slug":"_7-1-下载证书并上传","link":"#_7-1-下载证书并上传","children":[]},{"level":3,"title":"7.2 配置ssl证书","slug":"_7-2-配置ssl证书","link":"#_7-2-配置ssl证书","children":[]}]}],"readingTime":{"minutes":10.93,"words":3280},"git":{"createdTime":1731581071000,"updatedTime":1733476671000,"contributors":[{"name":"banxia","email":"yutong9717@163.com","commits":2},{"name":"unravely","email":"yutong9717@163.com","commits":1}]},"autoDesc":true,"filePathRelative":"notes/note_nginx/2.配置nginx.md","bulletin":false}')}}]);